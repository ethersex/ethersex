#!/bin/sh

test_path() {
  IFS=":"
  
  for check_path in $PATH; do  
     if [ -e "$check_path/$1" ]; then
       good="1"
     fi  
  done
  IFS=""

  if [ -z "$good" ]; then
    echo "Error: $1 not found in your path, can't continue"
    exit -1
  fi
}

test_path host

if [ -d named_pin ]; then
  cd named_pin
fi


tmp=`mktemp`
tmp2=`mktemp`
cat <<EOF
/* Autogenerated File */
#define OUTPUT 0
#define INPUT 1
#define LOW 0
#define HIGH 1
EOF
echo "const struct PinConfiguration portio_pincfg[] PROGMEM = {" >> $tmp
echo -e "    /*  port\tpin\tinput\treverse? */" >> $tmp
grep -v -e ^# < config | while read line; do
  port=`echo $line | awk '{print $1}' | cut -c 2 | tr 'ABCDabcd' '01230123'`
  pin=`echo $line | awk '{print $1}' | cut -c 3`
  input=`echo $line | awk '{print $2}'`
  active_high=`echo $line | awk '{print $3}'`
  name=`echo $line | awk '{print $4}'`
  
  textid=$RANDOM
  while grep -q $textid $tmp2; do
    textid=$RANDOM

  done
  echo $textid >> $tmp2
  echo "const char named_pin_text$textid[] PROGMEM = \"$name\";";
  echo -e "    {   $port,\t$pin,\t$input,\t$active_high,\tnamed_pin_text$textid }, \t/* $name\t*/ " >> $tmp
done

echo
cat $tmp
echo ""
echo "    /* mark the end of the list */"
echo "    { 255, 255, 255, 255, NULL}"
echo "};"

rm -f $tmp $tmp2
